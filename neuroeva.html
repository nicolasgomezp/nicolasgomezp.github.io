<html>
<body>
    <div style="position: relative;">
        <video id="webcam" width="640" height="480" autoplay style="position: relative; z-index: 1;"></video>
        <div id="output" style="position: absolute; top: 10px; left: 10px; color: white; background-color: rgba(0, 0, 0, 0.5); padding: 5px; z-index: 2;">Loading...</div>
    </div>
    <canvas id="canvas" width="640" height="480" style="display:none;"></canvas>
    <button id="captureButton">Capture and Analyze</button>
    <button id="switchCameraButton">Switch Camera</button>

    <script src="https://js.puter.com/v2/"></script>
    <script>
        const video = document.getElementById('webcam');
        const canvas = document.getElementById('canvas');
        const captureButton = document.getElementById('captureButton');
        const outputDiv = document.getElementById('output');
        const switchCameraButton = document.getElementById('switchCameraButton');
        const context = canvas.getContext('2d');

        let currentStream = null;
        let facingMode = 'environment'; // 'user' for front camera, 'environment' for back camera

        async function startWebcam() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: facingMode } 
                });
                handleStream(stream);
            } catch (err) {
                console.error("Error accessing webcam:", err);
                outputDiv.textContent = "Error accessing webcam. Please check permissions.";
            }
        }

        function handleStream(stream) {
            if (currentStream) {
                currentStream.getTracks().forEach(track => track.stop()); // Stop existing stream
            }
            video.srcObject = stream;
            currentStream = stream;
        }


        function captureImage() {
            context.drawImage(video, 0, 0, 640, 480);
            const imageDataURL = canvas.toDataURL('image/jpeg'); // Get image as Base64
            return imageDataURL;
        }

        function speak(text) {
            const utterance = new SpeechSynthesisUtterance(text);
            window.speechSynthesis.speak(utterance);
        }


        async function analyzeImage() {
            const imageBase64 = captureImage();
            outputDiv.textContent = "Analyzing...";

            try {
                const response = await puter.ai.chat(
                    "Que ves?",
                    imageBase64
                );
                outputDiv.textContent = response;
                speak(response); // Speak the response

            } catch (error) {
                console.error("Error analyzing image:", error);
                outputDiv.textContent = "Error analyzing image.";
                speak("Error analyzing image."); // Speak the error
            }
        }

        async function switchCamera() {
            facingMode = (facingMode === 'user') ? 'environment' : 'user';
            await startWebcam();
        }

        // Start the webcam when the page loads
        startWebcam();

        captureButton.addEventListener('click', analyzeImage);
        switchCameraButton.addEventListener('click', switchCamera);
    </script>
</body>
</html>
