<html>
<body>
    <div style="position: relative;">
        <video id="webcam" width="640" height="480" autoplay style="position: relative; z-index: 1;"></video>
        <div id="output" style="position: absolute; top: 10px; left: 10px; color: white; background-color: rgba(0, 0, 0, 0.5); padding: 5px; z-index: 2;"></div>
    </div>
    <canvas id="canvas" width="640" height="480" style="display:none;"></canvas>
    <button id="analyzeDetailedButton">Detailed Analysis</button>
    <button id="analyzeShortButton">Short Description</button>
    <button id="analyzeResolveButton">Leer</button>
    <button id="toggleContinuousButton">Start Continuous</button>
    <button id="switchCameraButton">Switch Camera</button>
    <button id="analyzeSingleButton" style="background-color: red; color: white;">Single Analysis</button>

    <script src="https://js.puter.com/v2/"></script>
    <script>
        const video = document.getElementById('webcam');
        const canvas = document.getElementById('canvas');
        const outputDiv = document.getElementById('output');
        const analyzeDetailedButton = document.getElementById('analyzeDetailedButton');
        const analyzeShortButton = document.getElementById('analyzeShortButton');
        const analyzeResolveButton = document.getElementById('analyzeResolveButton');
        const toggleContinuousButton = document.getElementById('toggleContinuousButton');
        const switchCameraButton = document.getElementById('switchCameraButton');
        const analyzeSingleButton = document.getElementById('analyzeSingleButton');
        const context = canvas.getContext('2d');

        let currentStream = null;
        let facingMode = 'environment';
        let isSpeaking = false;
        let continuousAnalysisInterval;
        let selectedAnalysisType = null;
        let typingSpeed = 20;
        let lastAnalysis = ""; // Store the last analysis result

        async function startWebcam() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: { facingMode: facingMode }
                });
                handleStream(stream);
            } catch (err) {
                console.error("Error accessing webcam:", err);
                outputDiv.textContent = "Error accessing webcam. Please check permissions.";
            }
        }

        function handleStream(stream) {
            if (currentStream) {
                currentStream.getTracks().forEach(track => track.stop());
            }
            video.srcObject = stream;
            currentStream = stream;
        }

        function captureImage() {
            context.drawImage(video, 0, 0, 640, 480);
            const imageDataURL = canvas.toDataURL('image/jpeg');
            return imageDataURL;
        }

        function speak(text) {
            return new Promise((resolve, reject) => {
                if (isSpeaking) {
                    window.speechSynthesis.cancel();
                }

                const utterance = new SpeechSynthesisUtterance(text);
                utterance.voice = window.speechSynthesis.getVoices().find(voice => voice.lang === 'es-ES' || voice.lang === 'es');
                if (!utterance.voice){
                    utterance.voice = window.speechSynthesis.getVoices().find(voice => voice.lang === 'en-US' || voice.lang === 'en');
                    if (!utterance.voice){
                        console.warn("No suitable voice found. Using default.");
                    }
                }
                utterance.pitch = 1;
                utterance.rate = 1;
                utterance.volume = 1;

                utterance.onstart = () => {
                    isSpeaking = true;
                };

                utterance.onend = () => {
                    isSpeaking = false;
                    resolve();
                };

                utterance.onerror = () => {
                    isSpeaking = false;
                    console.error("Speech synthesis error.");
                    reject("Speech synthesis error.");
                };

                window.speechSynthesis.speak(utterance);
            });
        }

        async function typeWriter(text, element) {
            element.textContent = "";
            let i = 0;
            return new Promise((resolve) => {
                function next() {
                    if (i < text.length) {
                        element.textContent += text.charAt(i);
                        i++;
                        setTimeout(next, typingSpeed);
                    } else {
                        resolve();
                    }
                }
                next();
            });
        }

         // Function to compare strings for similarity
        function areSimilar(str1, str2, similarityThreshold = 0.7) {
            str1 = str1.toLowerCase().trim();
            str2 = str2.toLowerCase().trim();

            if (str1 === str2) {
                return true; // Exact match
            }

            const words1 = str1.split(/\s+/);
            const words2 = str2.split(/\s+/);

            let commonWords = 0;
            for (const word1 of words1) {
                if (words2.includes(word1)) {
                    commonWords++;
                }
            }

            const similarityRatio = commonWords / Math.max(words1.length, words2.length);

            return similarityRatio >= similarityThreshold;
        }


        async function analyzeImage(prompt) {
            if (isSpeaking) {
                return;
            }

            outputDiv.textContent = "Analizando...";
            try {
                const imageBase64 = captureImage();
                const response = await puter.ai.chat(
                    prompt,
                    imageBase64
                );

                if (!areSimilar(response, lastAnalysis)) {
                    await typeWriter(response, outputDiv);
                    await speak(response);
                    lastAnalysis = response; // Update lastAnalysis
                } else {
                    outputDiv.textContent = "Resultado similar al anterior, omitiendo.";
                    console.log("Similar result, skipping.");
                }

            } catch (error) {
                console.error("", error);
                await typeWriter("", outputDiv);
                await speak("");
            }
        }

        function startContinuousAnalysis() {
            if (selectedAnalysisType) {
                continuousAnalysisInterval = setInterval(async () => {
                    await analyzeImage(selectedAnalysisType.prompt);
                }, 2000);
            }
        }

        function stopContinuousAnalysis() {
            clearInterval(continuousAnalysisInterval);
        }

        function toggleContinuousAnalysis() {
            if (continuousAnalysisInterval) {
                stopContinuousAnalysis();
                toggleContinuousButton.textContent = "Start Continuous";
            } else {
                startContinuousAnalysis();
                toggleContinuousButton.textContent = "Stop Continuous";
            }
        }

        function selectAnalysisType(button, prompt) {
            analyzeDetailedButton.style.backgroundColor = '';
            analyzeShortButton.style.backgroundColor = '';
            analyzeResolveButton.style.backgroundColor = '';
            analyzeSingleButton.style.backgroundColor = '';

            button.style.backgroundColor = 'lightgreen';

            selectedAnalysisType = { button: button, prompt: prompt };
            stopContinuousAnalysis();
            toggleContinuousButton.textContent = "Start Continuous"

        }

        async function switchCamera() {
            facingMode = (facingMode === 'user') ? 'environment' : 'user';
            await startWebcam();
        }

        // Event listeners
        analyzeDetailedButton.addEventListener('click', () => selectAnalysisType(analyzeDetailedButton, "Describe la escena detalladamente."));
        analyzeShortButton.addEventListener('click', () => selectAnalysisType(analyzeShortButton, "Que ves? Maximo 3 palabras, puedes usar menos(1, 2), usa lenguaje natural."));
        analyzeResolveButton.addEventListener('click', () => selectAnalysisType(analyzeResolveButton, "Lee el texto(si esta en otro idioma traduce al espanol) no agregues simbolos inncesarios ya que se usara para un texto a voz asi que debe ser generado en lenguaje natural"));
        toggleContinuousButton.addEventListener('click', toggleContinuousAnalysis);
        switchCameraButton.addEventListener('click', switchCamera);
        analyzeSingleButton.addEventListener('click', async () => {
            if (selectedAnalysisType) {
                await analyzeImage(selectedAnalysisType.prompt);
            }else{
              outputDiv.textContent = "Por favor, selecciona un tipo de an√°lisis primero.";
            }
        });

        // Start the webcam when the page loads
        startWebcam();
    </script>
</body>
</html>
